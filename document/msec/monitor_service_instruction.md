# 监控服务使用说明文档

# 服务介绍
    
## 路径介绍

监控服务分为mysql服务（用于存储告警相关信息）和监控服务。

### mysql服务

mysql服务位于/usr/local/mysql目录下。

### 监控服务

监控服务位于/usr/local/monitor目录下：

```
|-- bin
| |-- monitor_server		#业务主程序
| `-- start.sh 			#业务启动/重启脚本
|-- conf
\ `-- monitor_server.ini #业务配置
```

## 关键数据

关键的监控服务属性项数据和监控按天数值数据以共享内存（共享内存key值对应配置中的service_key和data_key）形式存于服务器中；用户可通过触发-USR1信号定时将两者数据备份到磁盘上，并在启动时自动恢复，默认的备份操作是通过crontab触发的，用户可自行修改crontab控制备份频率。

### 监控告警数据(mysql)

数据位于/msec/mysqldata/alarmdb。如果监控告警数据较多，用户可定期清理alarmdb数据库中alarm表里的数据。

### 监控内存要求和数据备份

监控共享内存数据大小默认值=(机器内存大小-2GB)*80%，用户可以通过修改监控配置项修改监控服务的共享内存大小，这同时也会影响备份数据大小。对应的监控配置项为monitor_server.ini中的：

```ini
[shm]
memory_left = 2048  #需保留的内存大小，单位为M
memory_percent = 80 #除去保留内存后，使用的内存百分比，用于创建共享内存
```

备份数据位于/msec/monitor_data/dump。用户可以通过crontab触发-USR1将数据。用户重启服务时，监控服务会先检查共享内存段是否存在，如果不存在则从备份数据中恢复。

## 关键流程

如果使用docker启动，会自动启动监控服务，并监听48002和48003端口（对应配置中的set_port和get_port端口，注意：需使用连续端口），其中第一个端口用于接收服务器的监控上报（需要配置到LB服务上），第二个端口用于接收来自web console的监控图表数据获取请求。

监控服务是内存开销型业务，默认会使用机器80%（对应配置中的memory_percent配置）的内存创建共享内存存储监控数据。

